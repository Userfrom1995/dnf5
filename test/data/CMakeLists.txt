# find all *.in files, strip the suffix and configure them
file(GLOB_RECURSE in_files RELATIVE "${CMAKE_CURRENT_SOURCE_DIR}" "*.in")
foreach(in_file ${in_files})
    string(REGEX REPLACE ".in$" "" out_file "${in_file}")
    configure_file("${CMAKE_CURRENT_SOURCE_DIR}/${in_file}" "${CMAKE_CURRENT_BINARY_DIR}/${out_file}" @ONLY)
endforeach()

file(COPY "${CMAKE_CURRENT_SOURCE_DIR}/cmdline-rpms" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")
file(COPY "${CMAKE_CURRENT_SOURCE_DIR}/keys" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")
file(COPY "${CMAKE_CURRENT_SOURCE_DIR}/repos-repomd" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")
file(COPY "${CMAKE_CURRENT_SOURCE_DIR}/repos-rpm" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")
file(COPY "${CMAKE_CURRENT_SOURCE_DIR}/repos-rpm-conf.d" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")
file(COPY "${CMAKE_CURRENT_SOURCE_DIR}/repos-solv" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")

set(BUILD_RPMS_AND_REPOS_SCRIPT "${CMAKE_CURRENT_BINARY_DIR}/build-rpms-and-repos.sh")
file(READ "${CMAKE_CURRENT_SOURCE_DIR}/build-rpms-and-repos.sh" BUILD_RPMS_AND_REPOS_SCRIPT_CONTENT)
string(REPLACE "\r\n" "\n" BUILD_RPMS_AND_REPOS_SCRIPT_CONTENT "${BUILD_RPMS_AND_REPOS_SCRIPT_CONTENT}")
file(WRITE "${BUILD_RPMS_AND_REPOS_SCRIPT}" "${BUILD_RPMS_AND_REPOS_SCRIPT_CONTENT}")
execute_process(COMMAND chmod +x "${BUILD_RPMS_AND_REPOS_SCRIPT}")

add_custom_target(build_rpm_and_repos ALL COMMAND "${BUILD_RPMS_AND_REPOS_SCRIPT}" "${CMAKE_CURRENT_BINARY_DIR}")
